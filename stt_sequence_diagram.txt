---
config:
  layout: elk
  theme: mc
---
flowchart TB
 subgraph subGraph0["Client"]
    direction TB
        Browser["Browser (React SPA)"]
        User("End User")
  end
  subgraph WebServer
      Nginx["Nginx<br>(Reverse Proxy & Static Server)"]
  end
 subgraph subGraph2["Spring Boot Application"]
    direction LR
    subgraph WebLayer["Web Layer"]
      direction TB
      Security["Spring Security<br>(JWT Authentication)"]
      Controller["REST Controllers"]
    end
    AOP["AOP<br>(Logging Aspect)"]
    subgraph ServiceLayer["Service Layer<br>(Business Logic)"]
      direction LR
      FileService["File Service"]
      subgraph STT
        Service["STT Service"]
        subgraph provider
        direction TB
          SttProvider["Stt Provider"]
          WebClient["WebClient<br>(reactive)"]
        end
        subgraph processing
          LockManager["Lock Manager"]
          TaskListener["Task Listener"]
          Scheduler["AbnormalTerminationScheduler<br>Encoding Scheduler<br>Processing Scheduler<br>Summarizing Scheduler"]
          TaskProcessor["Task Processor"]
        end
      end
      IssueService["Issue Service"]
      MeetingService["Meeting Service"]
      subgraph Notification
        direction TB
        NotificationService["Notification Service"]
        WebPushService["WebPush Service"]
      end
    end
    subgraph DataAccessLayer["Data Access Layer"]
      direction TB
      Repository["Spring Data JPA"]
      EntityManager
      RedisTemplate
      KafkaTemplate
    end
  end
 subgraph subGraphKafka["Apache Kafka"]
    direction TB
        Topic["Topic<br><br>notification-topic<br>stt-abnormal-termination-topic<br>stt-encoding-topic<br>stt-processing-topic<br>stt-summarizing-topic"]
  end
 subgraph subGraphRedisKV["Key-Value"]
        KV["Cache<br><br>stt:status:{id}"]
        LOCK["Distributed Lock<br><br>stt:processor:lock:abnormal-termination<br>stt:processor:lock:encoding<br>stt:processor:lock:processing<br>stt:processor:lock:summarizing"]
  end
 subgraph subGraphRedisStructs["Data Structures"]
    direction LR
        Sets["Sets<br><br>stt:recording<br>stt:encoding<br>stt:processing<br>stt:summarizing"]
        Hashes["Hashes<br><br>stt:recording:session<br>webpush:subscriptions"]
  end
 subgraph subGraphRedis["Redis"]
    direction TB
        subGraphRedisKV
        subGraphRedisStructs
  end
 subgraph subGraph3["Infrastructure"]
    direction TB
    subgraph MessageQueue["Message Queue"]
      subGraphKafka
    end
    subgraph DataStores["Data Stores"]
      subGraphRedis
      MySQL["MySQL DB"]
    end
    DiskStorage["Disk Storage"]
    ffmpeg["ffmpeg"]
  end
 subgraph subGraph4["Server Host"]
    direction TB
        subGraph2
        subGraph3
  end
 subgraph subGraph5["External Services"]
    direction TB
        PushService["Web Push Service<br>(FCM & APNs)"]
        DagloService["Daglo Service"]
  end
    User --> Browser
    Browser -- "HTTPS Request" --> Nginx
    Nginx -- "Proxy Pass (/api)" --> Security
    Security --> Controller
    Controller --> Service
    Service --> Repository
    Service -- Save & Encoding File --> FileService
    NotificationService -- publish Notification --> KafkaTemplate
    Controller -- Proxy --> AOP
    AOP -- Proceed JoinPoint --> MeetingService
    AOP -- Proceed JoinPoint --> IssueService
    AOP -- Logging --> EntityManager
    MeetingService --> Repository
    IssueService --> Repository
    Repository --> EntityManager
    EntityManager -- JDBC --> MySQL
    Service -- Cache Status & Task Queue --> RedisTemplate
    RedisTemplate -- Queuing --> Sets
     RedisTemplate -- Caching --> KV
    RedisTemplate -- Subscriptions & Sessions --> Hashes
    KafkaTemplate -- Publishes to --> Topic
    Service --> SttProvider
    SttProvider -- Delegate HTTP --> WebClient
    WebClient -- API Call --> DagloService
    FileService -- File I/O --> DiskStorage
    FileService -- Audio encoding --> ffmpeg
    PushService -- Delivers Notification --> Browser
    TaskListener -- Trigger Scheduling --> Scheduler
    LockManager -- Manage Lock --> RedisTemplate
    RedisTemplate -- Locking --> LOCK
    Scheduler -- Lock Check & Acquire --> LockManager
    Scheduler -- Delegate Execution --> TaskProcessor
    Service -- Publish Task --> KafkaTemplate
    Controller -- WebPush Subscribe --> WebPushService
    WebPushService -- API Call --> PushService
    NotificationService -- Pass Subscriptions --> WebPushService
    Controller --> NotificationService
    WebPushService -- save Subscriptions --> RedisTemplate
    NotificationService -- save history --> Repository
    Topic -- Consumed Notification --> WebPushService
    Topic -- Consumed Task --> TaskListener

     Browser:::frontend
     User:::frontend
     AOP:::backend
     Controller:::backend
     Security:::backend
     Service:::backend
     FileService:::backend
     Repository:::backend
     subGraphKafka:::services
     subGraphRedis:::services
     MySQL:::services
     DiskStorage:::services
     ffmpeg:::services
     PushService:::services
     DagloService:::services
     Nginx:::webserver
     WebPushService:::backend
     NotificationService:::backend
     RedisTemplate:::backend
     KafkaTemplate:::backend
     IssueService:::backend
     MeetingService:::backend
     EntityManager:::backend
     
    classDef frontend fill:#cde4ff,stroke:#446,stroke-width:2px
    classDef backend fill:#ffcdd2,stroke:#644,stroke-width:2px
    classDef services fill:#dcedc8,stroke:#464,stroke-width:2px
    classDef webserver fill:#fff9c4,stroke:#664,stroke-width:2px