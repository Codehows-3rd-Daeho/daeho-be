---
config:
  layout: elk
---
flowchart TB
 subgraph subGraph0["Client"]
    direction TB
        Browser["Browser (React SPA)"]
        User("End User")
  end
  subgraph WebServer
      Nginx["Nginx<br>(Reverse Proxy & Static Server)"]
  end
 subgraph subGraph1["Messaging Components"]
    direction LR
        KafkaProducer["Kafka Producer"]
        KafkaConsumer["Kafka Consumer"]
  end
 subgraph subGraph2["Spring Boot Application"]
    direction TB
    subgraph WebLayer["Web Layer"]
      direction TB
      Security["Spring Security<br>(JWT Authentication)"]
      Controller["REST Controllers"]
    end
    AOP["AOP<br>(Logging)"]
    subgraph ServiceLayer["Service Layer<br>(Business Logic)"]
      direction TB
      FileService["FileService"]
      Service["STT Service"]
    end
    subgraph DataAccessLayer["Data Access Layer"]
      direction TB
      Repository["Spring Data JPA<br>+ QueryDSL"]
    end
    subGraph1
  end
 subgraph subGraphKafka["Apache Kafka"]
    direction TB
        Topic["Topic:<br>notification-topic"]
  end
 subgraph subGraphRedisPubSub["Pub/Sub"]
        Channel["Channel:<br>STT_TASK_CHANNEL"]
  end
 subgraph subGraphRedisKV["Key-Value"]
        KV["stt:status:{id}<br>stt:processor:lock"]
  end
 subgraph subGraphRedisStructs["Data Structures"]
    direction LR
        Sets["Sets<br><br>stt:recording<br>stt:encoding<br>stt:processing<br>stt:summarizing"]
        Hashes["Hashes<br><br>stt:lastChunkTimestamp<br>webpush:subscriptions"]
  end
 subgraph subGraphRedis["Redis"]
    direction TB
        subGraphRedisPubSub
        subGraphRedisKV
        subGraphRedisStructs
  end
 subgraph subGraph3["Infrastructure"]
    direction TB
    subgraph MessageQueue["Message Queue"]
      subGraphKafka
    end
    subgraph DataStores["Data Stores"]
      subGraphRedis
      MySQL["MySQL DB"]
    end
    DiskStorage["Disk Storage"]
    ffmpeg["ffmpeg"]
  end
 subgraph subGraph4["Server Host"]
    direction TB
        subGraph2
        subGraph3
  end
 subgraph subGraph5["External Services"]
    direction TB
        PushService["Web Push Service"]
        DagloService["Daglo Service"]
  end
    User --> Browser
    Browser -- "HTTPS Request" --> Nginx
    Nginx -- "Proxy Pass (/api)" --> Security
    Security --> Controller
    Controller --> Service
    Service --> Repository & KafkaProducer & FileService
    KafkaConsumer --> Service
    Controller -.-> AOP
    AOP -.-> Service
    Repository -- Reads/Writes --> MySQL
    Service -- Read/Write --> KV & Sets & Hashes
    Service -- Pub/Sub --> Channel
    KafkaProducer -- Publishes to --> Topic
    Topic -- Consumed by --> KafkaConsumer
    Service -- API Call --> DagloService
    Service -- Triggers Push --> PushService
    FileService -- File I/O --> DiskStorage
    FileService -- Audio encoding --> ffmpeg
    PushService -- Delivers Notification --> Browser

     Browser:::frontend
     User:::frontend
     KafkaProducer:::backend
     KafkaConsumer:::backend
     AOP:::backend
     Controller:::backend
     Security:::backend
     Service:::backend
     FileService:::backend
     Repository:::backend
     subGraphKafka:::services
     subGraphRedis:::services
     MySQL:::services
     DiskStorage:::services
     ffmpeg:::services
     PushService:::services
     DagloService:::services
     Nginx:::webserver
    classDef frontend fill:#cde4ff,stroke:#446,stroke-width:2px
    classDef backend fill:#ffcdd2,stroke:#644,stroke-width:2px
    classDef services fill:#dcedc8,stroke:#464,stroke-width:2px
    classDef webserver fill:#fff9c4,stroke:#664,stroke-width:2px